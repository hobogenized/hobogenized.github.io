<!DOCTYPE HTML>
<head>
	<title>Final Graphics Project</title>
</head>
<body>

<script src=CT_Modeler.js></script>
<script>

	var viewHalfX = null,
	    viewHalfY = null;

	var pressedKeys = {};
	var translX = 0,
	    translY = 0,
		translZ = 0;
	var transf = [];
	
	var mouseDown = false;
	var prevMouseX = null,
	    prevMouseY = null;
		
	var mouseX = 0,
	    mouseY = 0;

	function init() {
		var sin = Math.sin, cos = Math.cos, PI = Math.PI;

		window.scene = new CT.Scene(canvas1);
		scene.setLight(0, [1,1,1]);

		window.obj = new CT.Node().scale(.13);
		scene.add(obj);
		
		var obj1 = new CT.Node();
		obj.addChild(obj1);

		obj1.addChild(new CT.Cube());
		obj1.getChild(0).setTexture('images/xy.png');

		obj1.addChild(new CT.Cylinder(8));
		obj1.getChild(1).setFragmentShader(
		  ['precision highp float;'
		  ,'varying vec3 vNormal;'
		  ,'void main() { vec3 n = normalize(vNormal); gl_FragColor = vec4(n*n,1.); }'
		  ].join('\n')
		);
		
		var obj2 = new CT.Node();
		obj.addChild(obj2);

		obj2.addChild(new CT.Extruded(16,100,
					function(u,v){ v=.30-.06*cos(2*PI*v); u*=4*PI; return [v*cos(u),v*sin(u)] },          // PROFILE
					function(v){v*=4*PI;var r=1-cos(1.5*v)/5;return[sin(1.5*v)/2,r*cos(v),r*sin(v)];})); // PATH
		obj2.getChild(0).setColor([1,0,0]);

		obj2.addChild(new CT.Parametric(20,20,function(u,v){return [2*u-1, 2*v-1, sin(1+10*u)*sin(1+10*v)/4];}));
		obj2.getChild(1).setColor([0,1,1]);

		obj2.addChild(new CT.Revolved(16, 8, function(t) { return [sin(PI * 5 * t), 2*t-1]; } ));
		obj2.getChild(2).setColor([0,1,0]);
		
		var obj3 = new CT.Node();
		obj.addChild(obj3);

		obj3.addChild(new CT.Sphere(16, 8));
		obj3.getChild(0).setColor([1,1,1]).setTexture('images/brick.png');

		obj3.addChild(new CT.Square());
		obj3.getChild(1).setColor([1,1,0]).setNormalMap('images/normal_map_1.png');

		obj3.addChild(new CT.Torus(32, 16, .6));
		obj3.getChild(2).setPhong([.1,.04,.01, 1,.4,.1, .2,.2,.2,5])
						   .setTexture('images/This_is_not_a_bagel.jpg')
						   .setNormalMap('images/normal_map_2.jpg');
						   
		viewHalfX = window.innerWidth / 2;
		viewHalfY = window.innerHeight / 2;
		
		document.onkeydown = handleKeyDown;
		document.onkeyup = handleKeyUp;
		canvas1.onmousedown = handleMouseDown;
        document.onmouseup = handleMouseUp;
        document.onmousemove   = handleMouseMove;
	}
	
	function handleKeyDown(e) {
		pressedKeys[e.which] = true;
	}
	
	function handleKeyUp(e) {
		pressedKeys[e.which] = false;
	}
	
	function handleKeys() {
		var k = pressedKeys;
		if (k[87]) {
			translZ += 0.5;//console.log("W pressed");
		}
		if (k[65]) {
			translX += 0.5;//console.log("A pressed");
		}
		if (k[83]) {
			translZ -= 0.5;//console.log("S pressed");
		}
		if (k[68]) {
			translX -= 0.5;//console.log("D pressed");
		}
	}
	
	function handleMouseDown(e) {
	
	}
	
	function handleMouseUp(e) {
	
	}
	
	function handleMouseMove(e) {
		mouseX = e.pageX - viewHalfX;
		mouseY = e.pageY - viewHalfY;
	}

	function resetProperties() {
		translX = 0;
		translY = 0;
		translZ = 0;
	}

	function update() {
		for (var i = 0 ; i < obj.numChildren() ; i++) {
		  var currObj = obj.getChild(i);
		  currObj.translate(0, 1, 1);
		  for (var j =0; j < currObj.numChildren(); ++j) {
			currObj.getChild(j).identity().translate(4*(j%4)-6, j<4?2:-2, 0).rotateY(time).rotateX(time/2);
		  }
		}
		obj.draw();
		resetProperties();
		handleKeys();
		obj.translate(translX, translY, translZ);
		//console.log("Mouse x: " + mouseX + ", Mouse y: " + mouseY);
	}

	setTimeout(function() {
			init();
			setInterval(function() {
				window.time = (new Date()).getTime() / 1000;
				update();
			}, 16);
		}, 100
	);

</script>
<center>
<canvas id=canvas1 width=1024 height=768></canvas>
</center>
</body>
