<!DOCTYPE HTML>
<head>
	<title>Final Graphics Project</title>
	 <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src=CT_Modeler.js></script>
</head>
<body style="background:white;">


<script>
	var pressedKeys = {};

	var translX = 0,
	    translY = 0,
		translZ = 0;
	
	var mouseDown = false,
		growBigger = false,
		shrinkSmaller = false;
		
	var deltaMouseX = 0,
	    deltaMouseY = 0;
	
	var scaleFactor = 2,
		mouseScale = 3;

	var worldTransform = CT.matrixIdentity();
	
	var camera;

	function init() {
		var sin = Math.sin, cos = Math.cos, PI = Math.PI;

		window.scene = new CT.Scene(canvas1);
		scene.setLight(0, [1,1,1]);
		
		window.bigobj = new CT.Node();
		scene.add(bigobj);

		window.objs = new CT.Node().scale(.001);
		bigobj.addChild(objs);

		var obj1 = new CT.Node();
		objs.addChild(obj1);

		bigobj.addChild(new CT.Parametric(20,20,function(u,v){
				return [2*u-1 * cos(u) / Math.max(sin(v), .001), 2*v-1 / Math.max(sin(u), .001), sin(1+10*u)*sin(1+10*v)/4];
			}
			));
		bigobj.getChild(1).setColor([0,1,1]);
		bigobj.rotateY(90 * PI / 180);
		bigobj.getChild(1).translate(0, 0, 0);
		bigobj.getChild(1).setFragmentShader(
		  ['precision highp float;'
		  ,'varying vec3 vNormal;'
		  ,'void main() {'
		  , 'vec3 n = normalize(vNormal);' 
		  , 'gl_FragColor = vec4(n*n,1.); }'
		  ].join('\n')
		);
		
		/*
		bigobj.addChild(new CT.Revolved(16, 8, function(t) {
				return [sin(PI * 5 * t)/-Math.max(cos(Math.max(sin(t), .001),.001)), -(2*t-1 / Math.max(cos(t), .001))]; 
			} 
			));
		bigobj.getChild(1).setColor([0,1,0]);
		bigobj.getChild(1).rotateZ(90 * PI / 180);
		//*/
		obj1.addChild(new CT.Revolved(20,20,function(u){
				return [-2*u-1 / Math.max(sin(u), .001), sin(u)/ Math.max(-2*u-1, .001), sin(1+10*u)*cos(1+10*u)/4];
			}
			));
		obj1.getChild(0).setColor([0,1,1]);
		/*
		obj1.addChild(new CT.Cube());
		obj1.getChild(0).setTexture('images/xy.png');
		obj1.addChild(new CT.Cylinder(8));
		obj1.getChild(1).setFragmentShader(
		  ['precision highp float;'
		  ,'varying vec3 vNormal;'
		  ,'void main() { vec3 n = normalize(vNormal); gl_FragColor = vec4(n*n,1.); }'
		  ].join('\n')
		);
		//*/
		
		var obj2 = new CT.Node();
		objs.addChild(obj2);
/*
		var sphere = new CT.Sphere(128, 128);
		obj2.addChild(sphere);
		obj2.getChild(0).setTexture('images/sun.png');
		
		obj2.addChild(new CT.Extruded(16,100,
					function(u,v){ v=.06*cos(2*PI*v); u*=4*PI; return [v*sin(u)/Math.max(.001,cos(u)),v*sin(u)/Math.max(.001,cos(u))] },          // PROFILE
					function(v){v*=4*PI;var r=cos(1.5*v)/5;return[sin(1.5*v)/2,r*cos(v),r * cos(v)];})); // PATH
		obj2.getChild(1).setColor([1,0,0]);
		//*/
		/*
		var obj3 = new CT.Node();
		objs.addChild(obj3);
*/
		/*
		obj3.addChild(new CT.Sphere(16, 8));
		obj3.getChild(0).setColor([1,1,1]).setTexture('images/brick.png');

		obj3.addChild(new CT.Square());
		obj3.getChild(1).setColor([1,1,0]).setNormalMap('images/normal_map_1.png');

		obj3.addChild(new CT.Torus(32, 16, .6));
		obj3.getChild(2).setPhong([.1,.04,.01, 1,.4,.1, .2,.2,.2,5])
						   .setTexture('images/This_is_not_a_bagel.jpg')
						   .setNormalMap('images/normal_map_2.jpg');
		//*/
						
		var tube = new CT.Revolved(20, 16, function(t) { return[sin(t * PI / 2)/Math.max(sin(1/Math.max(.001,t)),.001), cos(t * 2 + 1) - 20];});	   
		var obj4 = new CT.Node();
		objs.addChild(obj4);
		obj4.addChild(tube);
		
		document.onkeydown = handleKeyDown;
		document.onkeyup = handleKeyUp;
		canvas1.onmousedown = handleMouseDown;
        document.onmouseup = handleMouseUp;
        document.onmousemove   = handleMouseMove;
		
		canvas1.requestPointerLock = canvas1.requestPointerLock ||
									 canvas1.mozRequestPointerLock ||
                                     canvas1.webkitRequestPointerLock;
									 
		canvas1.onclick = function() {
			canvas1.requestPointerLock();
		}
		
		document.exitPointerLock = document.exitPointerLock ||
			   document.mozExitPointerLock ||
			   document.webkitExitPointerLock;
	}
	
	function handleKeyDown(e) {
		pressedKeys[e.which] = true;
	}
	
	function handleKeyUp(e) {
		pressedKeys[e.which] = false;
	}
	
	function handleKeys() {
		var k = pressedKeys;
		if (k[81]) {
			growBigger = true; //console.log("Q pressed");
		}
		if (k[87]) {
			translZ -= 0.2;//console.log("W pressed");
		}
		if (k[65]) {
			translX -= 0.2;//console.log("A pressed");
		}
		if (k[83]) {
			translZ += 0.2;//console.log("S pressed");
		}
		if (k[68]) {
			translX += 0.2;//console.log("D pressed");
		}
		if (k[69]) {
			shrinkSmaller = true; // console.log("E pressed");
		}
	}

	function handleMouseDown(e) {
		mouseDown = true;
	}

	function handleMouseUp(e) {
		mouseDown = false;
	}

	function handleMouseMove(e) {
		deltaMouseX = e.movementX;
		deltaMouseY = e.movementY;
	}

	//CONVERTS DEGREES TO RADIANS	
	function degreesToRadians(degrees) {
		return degrees * Math.PI / 180;
	}

	//RETURNS DEGREES TO ROTATE CORRESPONDING TO HORIZONTAL MOUSE MOVEMENT
	function getDeltaMouseX() {
		return degreesToRadians(-deltaMouseX / mouseScale);
	}

	//RETURNS DEGREES TO ROTATE CORRESPONDING TO VERTICAL MOUSE MOVEMENT
	function getDeltaMouseY() {
		return degreesToRadians(-deltaMouseY / mouseScale);
	}

	//RETURNS SCALE FOR SCALING OBJECTS
	function getScale() {
		if (growBigger) {
			return scaleFactor;
		}
		if (shrinkSmaller) {
			return 1 / scaleFactor;
		}
		return 1;
	}

	//HANDLES ALL I/O MOVEMENT VIA MOUSE AND KEYBOARD
	function handleMovement() {
		camera = scene._viewMatrix;
		//SET HORIZONTAL MOUSE ROTATION
		worldTransform = CT.matrixRotatedY(getDeltaMouseX());
		//SET VERTICAL MOUSE ROTATION
		worldTransform = CT.matrixMultiply(worldTransform, 
										   CT.matrixRotatedX(getDeltaMouseY()),
										   []);
		//SET FORWARD/BACKWARD AND LEFT/RIGHT MOVEMENT
		worldTransform = CT.matrixMultiply(worldTransform,
										   CT.matrixTranslated(translX, translY, translZ),
										   []);
		//APPLY WORLD TRANSFORM
		camera = CT.matrixMultiply(camera, worldTransform, []);
		scene.setViewMatrix(camera);
	}

	function objectDraw() {
		for (var i = 0 ; i < objs.numChildren() ; i++) {
			var currObj = objs.getChild(i);
			//currobjs.translate(Math.sin(Math.PI * time - (Math.PI * time / 2)), 0, 0);
			for (var j =0; j < currObj.numChildren(); ++j) {
				currObj.getChild(j).identity().translate(4*(j%4)-6, j<4?2:-2, 0).rotateY(time).rotateX(time/2);
			}
		}
		/*
		for (var i = 1; i < bigobj.numChildren(); ++i) {
			bigobj.getChild(i);
		}*/
		objs.draw();
		bigobj.draw();
		//SCALE ALL OBJECTS BIGGER OR SMALLER
		if (growBigger || shrinkSmaller) {
			objs.scale(getScale(), getScale(), getScale());
		}
	}

	function resetProperties() {
		translX = 0;
		translY = 0;
		translZ = 0;
		deltaMouseX = 0;
		deltaMouseY = 0;
		growBigger = false;
		shrinkSmaller = false;
		worldTransform = CT.matrixIdentity();
	}

	function update() {
	
		objectDraw();
		handleKeys();
		handleMovement();
		resetProperties();
	}

	setTimeout(function() {
			init();
			setInterval(function() {
				window.time = (new Date()).getTime() / 1000;
				update();
			}, 16);
		}, 100
	);
</script>
<center>
<canvas id=canvas1 height=720 width=1080 style="background:black;"></canvas>
</center>
</body>
